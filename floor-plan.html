<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¡×•×›×Ÿ ×ª×›× ×•×Ÿ ×‘×™×ª - ×.×© ××œ×•××™× ×™×•× ×—×•×¥</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      direction: rtl;
      background: #f5f5f5;
    }

    /* ===== LAYOUT ===== */
    .fp-layout {
      display: flex;
      height: calc(100vh - 100px);
      gap: 0;
    }

    /* ===== LEFT PANEL (chat) ===== */
    .fp-chat-panel {
      width: 320px;
      min-width: 260px;
      background: #fff;
      border-left: 2px solid #e0d89a;
      display: flex;
      flex-direction: column;
    }
    .fp-chat-panel h3 {
      margin: 0;
      padding: 14px 16px;
      background: #333;
      color: #B6A24B;
      font-size: 1em;
      border-bottom: 2px solid #B6A24B;
    }
    .fp-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chat-msg {
      max-width: 90%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 0.92em;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .chat-msg.bot {
      background: #f0edd4;
      border: 1px solid #e0d89a;
      align-self: flex-end;
    }
    .chat-msg.user {
      background: #333;
      color: #B6A24B;
      align-self: flex-start;
    }
    .fp-chat-input {
      display: flex;
      border-top: 1px solid #e0d89a;
      padding: 8px;
      gap: 6px;
    }
    .fp-chat-input input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9em;
      direction: rtl;
    }
    .fp-chat-input button {
      padding: 8px 14px;
      background: #333;
      color: #B6A24B;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
    }
    .fp-chat-input button:hover { background: #555; }

    /* ===== CENTER (canvas) ===== */
    .fp-canvas-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #eee;
    }
    .fp-toolbar {
      background: #333;
      padding: 8px 12px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    .fp-toolbar .tool-btn {
      padding: 6px 12px;
      background: #555;
      color: #fff;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.82em;
      transition: background 0.15s, border-color 0.15s;
    }
    .fp-toolbar .tool-btn:hover { background: #777; }
    .fp-toolbar .tool-btn.active {
      background: #B6A24B;
      color: #222;
      border-color: #8d7a2c;
    }
    .fp-toolbar .tool-sep {
      width: 1px;
      height: 28px;
      background: #666;
      margin: 0 4px;
    }
    .fp-canvas-wrapper {
      flex: 1;
      overflow: auto;
      position: relative;
      cursor: crosshair;
    }
    #floor-plan-canvas {
      display: block;
      background: #fff;
      box-shadow: 0 2px 18px #0002;
      margin: 20px auto;
      cursor: crosshair;
    }

    /* ===== RIGHT PANEL (rooms list + properties) ===== */
    .fp-right-panel {
      width: 230px;
      min-width: 180px;
      background: #fff;
      border-right: 2px solid #e0d89a;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .fp-right-panel h3 {
      margin: 0;
      padding: 14px 16px;
      background: #333;
      color: #B6A24B;
      font-size: 1em;
      border-bottom: 2px solid #B6A24B;
    }
    .fp-rooms-list {
      padding: 8px;
      flex: 1;
    }
    .room-item {
      padding: 6px 10px;
      margin-bottom: 4px;
      border-radius: 6px;
      border: 1.5px solid #e0d89a;
      cursor: pointer;
      font-size: 0.88em;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.12s;
    }
    .room-item:hover { background: #f9f6e8; }
    .room-item.selected { background: #f0edd4; border-color: #B6A24B; }
    .room-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .fp-properties {
      padding: 8px;
      border-top: 1px solid #e0d89a;
    }
    .fp-properties h4 {
      margin: 0 0 8px 0;
      font-size: 0.9em;
      color: #555;
    }
    .prop-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 0.85em;
    }
    .prop-row label {
      width: 60px;
      color: #666;
      flex-shrink: 0;
    }
    .prop-row input {
      flex: 1;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.85em;
      direction: rtl;
    }
    .prop-row select {
      flex: 1;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.85em;
    }
    .btn-apply {
      width: 100%;
      padding: 6px;
      background: #B6A24B;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85em;
      margin-top: 4px;
    }
    .btn-apply:hover { background: #8d7a2c; }
    .btn-delete-room {
      width: 100%;
      padding: 6px;
      background: #c0392b;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85em;
      margin-top: 4px;
    }
    .btn-delete-room:hover { background: #a93226; }

    /* Upload overlay */
    #upload-label {
      cursor: pointer;
      padding: 6px 12px;
      background: #555;
      color: #fff;
      border: 2px solid transparent;
      border-radius: 6px;
      font-size: 0.82em;
    }
    #upload-label:hover { background: #777; }

    /* Scale indicator */
    .fp-scale {
      font-size: 0.78em;
      color: #aaa;
      margin-right: 8px;
    }
    .fp-scale input {
      width: 50px;
      padding: 3px 5px;
      border: 1px solid #666;
      border-radius: 4px;
      background: #444;
      color: #fff;
      font-size: 0.9em;
      text-align: center;
    }

    /* Status bar */
    .fp-status {
      background: #222;
      color: #aaa;
      font-size: 0.78em;
      padding: 3px 14px;
      min-height: 22px;
    }

    /* Heading section */
    .fp-hero {
      background: linear-gradient(135deg, #333 60%, #4a4a2a 100%);
      color: #B6A24B;
      text-align: center;
      padding: 18px 20px 12px;
    }
    .fp-hero h2 { margin: 0 0 4px 0; font-size: 1.4em; }
    .fp-hero p { margin: 0; font-size: 0.9em; color: #ddd; }

    @media (max-width: 768px) {
      .fp-layout { flex-direction: column; height: auto; }
      .fp-chat-panel, .fp-right-panel { width: 100%; min-width: unset; }
      .fp-canvas-area { min-height: 400px; }
    }
  </style>
</head>
<body>

<div id="header-placeholder"></div>
<script>
  fetch('header.html')
    .then(r => r.text())
    .then(d => { document.getElementById('header-placeholder').innerHTML = d; });
</script>

<div class="fp-hero">
  <h2>ğŸ  ×¡×•×›×Ÿ ×ª×›× ×•×Ÿ ×”×‘×™×ª</h2>
  <p>×¦×™×™×¨ ××ª ×©×¨×˜×•×˜ ×”×‘×™×ª ×©×œ×š, ×”×•×¡×£ ×—×“×¨×™×, ×”×’×“×œ ×—×œ×œ×™× ×•×§×‘×œ ×”××œ×¦×•×ª ×œ×ª×›× ×•×Ÿ</p>
</div>

<div class="fp-layout">

  <!-- RIGHT PANEL: rooms list + properties -->
  <div class="fp-right-panel">
    <h3>ğŸ›‹ï¸ ×—×“×¨×™×</h3>
    <div class="fp-rooms-list" id="rooms-list">
      <div style="color:#aaa;font-size:0.85em;padding:8px;">×¢×“×™×™×Ÿ ×œ× ×¦×•×™×¨×• ×—×“×¨×™×.<br>×‘×—×¨ ×›×œ×™ "×”×•×¡×£ ×—×“×¨" ×•×¦×™×™×¨!</div>
    </div>
    <div class="fp-properties" id="prop-panel" style="display:none;">
      <h4>âœï¸ ×¢×¨×™×›×ª ×—×“×¨</h4>
      <div class="prop-row">
        <label>×©×:</label>
        <input type="text" id="prop-name" placeholder="×—×“×¨ ×©×™× ×”" />
      </div>
      <div class="prop-row">
        <label>×¨×•×—×‘ (×'):</label>
        <input type="number" id="prop-width" min="0.5" step="0.5" />
      </div>
      <div class="prop-row">
        <label>×¢×•××§ (×'):</label>
        <input type="number" id="prop-height" min="0.5" step="0.5" />
      </div>
      <div class="prop-row">
        <label>×¡×•×’:</label>
        <select id="prop-type">
          <option value="room">×—×“×¨</option>
          <option value="bathroom">×—×“×¨ ×××‘×˜×™×”</option>
          <option value="kitchen">××˜×‘×—</option>
          <option value="living">×¡×œ×•×Ÿ</option>
          <option value="pergola">×¤×¨×’×•×œ×”</option>
          <option value="garden">×’×™× ×”</option>
          <option value="garage">××•×¡×š</option>
          <option value="other">××—×¨</option>
        </select>
      </div>
      <button class="btn-apply" id="btn-apply-props">âœ” ×©××•×¨ ×©×™× ×•×™×™×</button>
      <button class="btn-delete-room" id="btn-delete-room">ğŸ—‘ ××—×§ ×—×“×¨</button>
    </div>
  </div>

  <!-- CENTER: toolbar + canvas -->
  <div class="fp-canvas-area">
    <div class="fp-toolbar">
      <button class="tool-btn" id="tool-select" title="×‘×—×¨/×”×–×– ×—×“×¨">ğŸ–±ï¸ ×‘×—×¨</button>
      <button class="tool-btn" id="tool-room" title="×”×•×¡×£ ×—×“×¨ ×—×“×©">â• ×—×“×¨</button>
      <button class="tool-btn" id="tool-resize" title="×©×™× ×•×™ ×’×•×“×œ">â†” ×’×“×œ</button>
      <button class="tool-btn" id="tool-delete" title="××—×§ ×—×“×¨">ğŸ—‘ ××—×§</button>
      <div class="tool-sep"></div>
      <label id="upload-label" title="×”×¢×œ×” ×ª××•× ×ª ×©×¨×˜×•×˜ ×¨×§×¢">
        ğŸ“‚ ×˜×¢×Ÿ ×©×¨×˜×•×˜
        <input type="file" id="upload-bg" accept="image/*" style="display:none;" />
      </label>
      <button class="tool-btn" id="btn-clear-bg" title="× ×§×” ×¨×§×¢">âœ• × ×§×” ×¨×§×¢</button>
      <div class="tool-sep"></div>
      <span class="fp-scale">×¡×§××œ×”: <input type="number" id="scale-px" value="50" min="10" max="200" title="×¤×™×§×¡×œ×™× ×œ××˜×¨" /> px/×'</span>
      <div class="tool-sep"></div>
      <button class="tool-btn" id="btn-save" title="×©××•×¨ ×©×¨×˜×•×˜">ğŸ’¾ ×©××•×¨</button>
      <button class="tool-btn" id="btn-load" title="×˜×¢×Ÿ ×©×¨×˜×•×˜">ğŸ“¥ ×˜×¢×Ÿ</button>
      <button class="tool-btn" id="btn-clear-all" title="× ×§×” ×”×›×œ">ğŸ”„ × ×§×” ×”×›×œ</button>
    </div>
    <div class="fp-canvas-wrapper" id="canvas-wrapper">
      <canvas id="floor-plan-canvas" width="900" height="650"></canvas>
    </div>
    <div class="fp-status" id="status-bar">××•×›×Ÿ ×œ×¦×™×™×¨ â€“ ×‘×—×¨ ×›×œ×™ ×•×œ×—×¥ ×•×’×¨×•×¨ ×¢×œ ×”×œ×•×—</div>
  </div>

  <!-- LEFT PANEL: chat assistant -->
  <div class="fp-chat-panel">
    <h3>ğŸ¤– ×¡×•×›×Ÿ ×ª×›× ×•×Ÿ</h3>
    <div class="fp-chat-messages" id="chat-messages"></div>
    <div class="fp-chat-input">
      <input type="text" id="chat-input" placeholder="×©××œ ××•×ª×™ ×¢×œ ×ª×›× ×•×Ÿ ×”×‘×™×ª..." />
      <button id="chat-send">×©×œ×—</button>
    </div>
  </div>

</div>

<script>
// ===========================
// CONSTANTS & STATE
// ===========================
const canvas = document.getElementById('floor-plan-canvas');
const ctx = canvas.getContext('2d');
const statusBar = document.getElementById('status-bar');

const ROOM_TYPES = {
  room:      { color: '#d6eaf8', label: '×—×“×¨', icon: 'ğŸ›' },
  bathroom:  { color: '#d5f5e3', label: '×××‘×˜×™×”', icon: 'ğŸš¿' },
  kitchen:   { color: '#fef9e7', label: '××˜×‘×—', icon: 'ğŸ³' },
  living:    { color: '#fdebd0', label: '×¡×œ×•×Ÿ', icon: 'ğŸ›‹' },
  pergola:   { color: '#e8daef', label: '×¤×¨×’×•×œ×”', icon: 'â›±' },
  garden:    { color: '#d4efdf', label: '×’×™× ×”', icon: 'ğŸŒ¿' },
  garage:    { color: '#eaecee', label: '××•×¡×š', icon: 'ğŸš—' },
  other:     { color: '#f9f9f9', label: '××—×¨', icon: 'â¬œ' }
};

let rooms = [];          // array of room objects
let selectedRoom = null; // currently selected room index
let activeTool = 'room'; // current tool
let bgImage = null;      // background blueprint image
let scalePx = 50;        // pixels per meter

// Drawing state
let isDrawing = false;
let isDragging = false;
let isResizing = false;
let dragStart = { x: 0, y: 0 };
let resizeHandle = null;
let roomDraft = null;    // in-progress new room

let roomCounter = 1;

// ===========================
// TOOL SELECTION
// ===========================
const toolBtns = document.querySelectorAll('.tool-btn[id^="tool-"]');
function setTool(tool) {
  activeTool = tool;
  toolBtns.forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('tool-' + tool);
  if (btn) btn.classList.add('active');
  canvas.style.cursor = tool === 'room' ? 'crosshair' : (tool === 'delete' ? 'not-allowed' : 'default');
  setStatus('×›×œ×™ ×¤×¢×™×œ: ' + { select:'×‘×—×¨', room:'×”×•×¡×£ ×—×“×¨', resize:'×©×™× ×•×™ ×’×•×“×œ', delete:'××—×§' }[tool]);
}
toolBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const tool = btn.id.replace('tool-', '');
    setTool(tool);
  });
});

// ===========================
// CANVAS HELPERS
// ===========================
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: clientX - rect.left, y: clientY - rect.top };
}

function normalizeRect(x, y, w, h) {
  return {
    x: w < 0 ? x + w : x,
    y: h < 0 ? y + h : y,
    w: Math.abs(w),
    h: Math.abs(h)
  };
}

function getHandles(room) {
  const { x, y, w, h } = room;
  return [
    { id: 'se', x: x + w, y: y + h },
    { id: 'sw', x: x,     y: y + h },
    { id: 'ne', x: x + w, y: y },
    { id: 'nw', x: x,     y: y },
    { id: 'n',  x: x + w/2, y: y },
    { id: 's',  x: x + w/2, y: y + h },
    { id: 'e',  x: x + w, y: y + h/2 },
    { id: 'w',  x: x,     y: y + h/2 },
  ];
}

function hitHandle(room, pos) {
  const HANDLE_R = 7;
  for (const h of getHandles(room)) {
    if (Math.abs(pos.x - h.x) <= HANDLE_R && Math.abs(pos.y - h.y) <= HANDLE_R) return h.id;
  }
  return null;
}

function hitRoom(pos) {
  for (let i = rooms.length - 1; i >= 0; i--) {
    const r = rooms[i];
    if (pos.x >= r.x && pos.x <= r.x + r.w && pos.y >= r.y && pos.y <= r.y + r.h) return i;
  }
  return -1;
}

// ===========================
// DRAWING
// ===========================
function drawAll() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Background image
  if (bgImage) {
    ctx.globalAlpha = 0.35;
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    ctx.globalAlpha = 1;
  }

  // Grid
  ctx.strokeStyle = '#e8e8e8';
  ctx.lineWidth = 0.5;
  for (let x = 0; x <= canvas.width; x += scalePx) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
  }
  for (let y = 0; y <= canvas.height; y += scalePx) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
  }

  // Rooms
  rooms.forEach((room, i) => {
    const type = ROOM_TYPES[room.type] || ROOM_TYPES.room;
    const isSelected = (i === selectedRoom);

    // Fill
    ctx.fillStyle = type.color;
    ctx.globalAlpha = isSelected ? 0.85 : 0.7;
    ctx.fillRect(room.x, room.y, room.w, room.h);
    ctx.globalAlpha = 1;

    // Border
    ctx.strokeStyle = isSelected ? '#B6A24B' : '#555';
    ctx.lineWidth = isSelected ? 2.5 : 1.5;
    ctx.strokeRect(room.x, room.y, room.w, room.h);

    // Label
    const wM = (room.w / scalePx).toFixed(1);
    const hM = (room.h / scalePx).toFixed(1);
    const area = (wM * hM).toFixed(1);
    const label = (room.name || type.label) + '\n' + wM + 'Ã—' + hM + ' ×\' (' + area + ' ×"×¨)';
    ctx.fillStyle = '#222';
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const lines = label.split('\n');
    const lineH = 15;
    const totalH = lines.length * lineH;
    lines.forEach((line, li) => {
      ctx.fillText(line, room.x + room.w / 2, room.y + room.h / 2 - totalH / 2 + li * lineH + lineH / 2);
    });

    // Icon
    ctx.font = '18px Arial';
    ctx.fillText(type.icon, room.x + 14, room.y + 14);

    // Resize handles (only for selected)
    if (isSelected) {
      getHandles(room).forEach(h => {
        ctx.fillStyle = '#B6A24B';
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(h.x, h.y, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
      });
    }
  });

  // Draft room while drawing
  if (isDrawing && roomDraft) {
    const d = normalizeRect(roomDraft.x, roomDraft.y, roomDraft.w, roomDraft.h);
    ctx.strokeStyle = '#B6A24B';
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.strokeRect(d.x, d.y, d.w, d.h);
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(182,162,75,0.15)';
    ctx.fillRect(d.x, d.y, d.w, d.h);
    const wM = (d.w / scalePx).toFixed(1);
    const hM = (d.h / scalePx).toFixed(1);
    ctx.fillStyle = '#8d7a2c';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(wM + 'Ã—' + hM + ' ×\'', d.x + d.w / 2, d.y + d.h / 2);
  }
}

// ===========================
// MOUSE / TOUCH EVENTS
// ===========================
canvas.addEventListener('mousedown', onDown);
canvas.addEventListener('mousemove', onMove);
canvas.addEventListener('mouseup', onUp);
canvas.addEventListener('touchstart', e => { e.preventDefault(); onDown(e); }, { passive: false });
canvas.addEventListener('touchmove',  e => { e.preventDefault(); onMove(e); }, { passive: false });
canvas.addEventListener('touchend',   e => { e.preventDefault(); onUp(e); },   { passive: false });

function onDown(e) {
  const pos = getPos(e);

  if (activeTool === 'room') {
    isDrawing = true;
    roomDraft = { x: pos.x, y: pos.y, w: 0, h: 0 };
  } else if (activeTool === 'select' || activeTool === 'resize') {
    // Check handle on selected room first
    if (selectedRoom !== null && selectedRoom >= 0) {
      const h = hitHandle(rooms[selectedRoom], pos);
      if (h) {
        isResizing = true;
        resizeHandle = h;
        dragStart = pos;
        return;
      }
    }
    // Check room hit
    const idx = hitRoom(pos);
    if (idx >= 0) {
      selectedRoom = idx;
      isDragging = activeTool === 'select';
      dragStart = { x: pos.x - rooms[idx].x, y: pos.y - rooms[idx].y };
      updatePropPanel();
      updateRoomsList();
    } else {
      selectedRoom = null;
      updatePropPanel();
      updateRoomsList();
    }
    drawAll();
  } else if (activeTool === 'delete') {
    const idx = hitRoom(pos);
    if (idx >= 0) {
      rooms.splice(idx, 1);
      if (selectedRoom === idx) selectedRoom = null;
      else if (selectedRoom > idx) selectedRoom--;
      updatePropPanel();
      updateRoomsList();
      drawAll();
      addBotMessage('×—×“×¨ × ××—×§. ' + rooms.length + ' ×—×“×¨×™× × ×•×ª×¨×• ×‘×©×¨×˜×•×˜.');
    }
  }
}

function onMove(e) {
  const pos = getPos(e);

  if (isDrawing && roomDraft) {
    roomDraft.w = pos.x - roomDraft.x;
    roomDraft.h = pos.y - roomDraft.y;
    const d = normalizeRect(roomDraft.x, roomDraft.y, roomDraft.w, roomDraft.h);
    setStatus('××¦×™×™×¨: ' + (d.w / scalePx).toFixed(1) + ' Ã— ' + (d.h / scalePx).toFixed(1) + ' ×\'');
    drawAll();
  } else if (isDragging && selectedRoom !== null) {
    rooms[selectedRoom].x = pos.x - dragStart.x;
    rooms[selectedRoom].y = pos.y - dragStart.y;
    drawAll();
  } else if (isResizing && selectedRoom !== null) {
    applyResize(rooms[selectedRoom], resizeHandle, pos);
    drawAll();
  } else {
    // Cursor hint
    if (selectedRoom !== null && selectedRoom >= 0) {
      const h = hitHandle(rooms[selectedRoom], pos);
      canvas.style.cursor = h ? getResizeCursor(h) : (activeTool === 'select' ? 'move' : 'crosshair');
    }
  }
}

function onUp(e) {
  if (isDrawing && roomDraft) {
    const d = normalizeRect(roomDraft.x, roomDraft.y, roomDraft.w, roomDraft.h);
    if (d.w > 20 && d.h > 20) {
      const newRoom = {
        x: d.x, y: d.y, w: d.w, h: d.h,
        name: '×—×“×¨ ' + roomCounter++,
        type: 'room'
      };
      rooms.push(newRoom);
      selectedRoom = rooms.length - 1;
      updatePropPanel();
      updateRoomsList();
      const wM = (d.w / scalePx).toFixed(1);
      const hM = (d.h / scalePx).toFixed(1);
      addBotMessage('× ×•×¡×£ ×—×“×¨ ×—×“×©: ' + wM + 'Ã—' + hM + ' ×\'. ×ª×•×›×œ ×œ×©× ×•×ª ××ª ×©××• ×•×¤×¨×˜×™×• ×‘×¤×× ×œ ×”×™×× ×™.');
    }
    isDrawing = false;
    roomDraft = null;
  }
  isDragging = false;
  isResizing = false;
  resizeHandle = null;
  drawAll();
  setStatus('××•×›×Ÿ');
}

function applyResize(room, handle, pos) {
  const minSize = 20;
  const origRight = room.x + room.w;
  const origBottom = room.y + room.h;
  if (handle.includes('e')) room.w = Math.max(minSize, pos.x - room.x);
  if (handle.includes('s')) room.h = Math.max(minSize, pos.y - room.y);
  if (handle.includes('w')) {
    const newX = Math.min(pos.x, origRight - minSize);
    room.w = origRight - newX;
    room.x = newX;
  }
  if (handle.includes('n')) {
    const newY = Math.min(pos.y, origBottom - minSize);
    room.h = origBottom - newY;
    room.y = newY;
  }
}

function getResizeCursor(h) {
  const map = { n:'ns-resize', s:'ns-resize', e:'ew-resize', w:'ew-resize',
    ne:'nesw-resize', sw:'nesw-resize', nw:'nwse-resize', se:'nwse-resize' };
  return map[h] || 'pointer';
}

// ===========================
// PROPERTIES PANEL
// ===========================
function updatePropPanel() {
  const panel = document.getElementById('prop-panel');
  if (selectedRoom === null || selectedRoom < 0 || !rooms[selectedRoom]) {
    panel.style.display = 'none';
    return;
  }
  panel.style.display = '';
  const r = rooms[selectedRoom];
  document.getElementById('prop-name').value = r.name || '';
  document.getElementById('prop-width').value = (r.w / scalePx).toFixed(2);
  document.getElementById('prop-height').value = (r.h / scalePx).toFixed(2);
  document.getElementById('prop-type').value = r.type || 'room';
}

document.getElementById('btn-apply-props').addEventListener('click', () => {
  if (selectedRoom === null || !rooms[selectedRoom]) return;
  const r = rooms[selectedRoom];
  r.name = document.getElementById('prop-name').value || r.name;
  r.type = document.getElementById('prop-type').value;
  const newW = parseFloat(document.getElementById('prop-width').value);
  const newH = parseFloat(document.getElementById('prop-height').value);
  if (!isNaN(newW) && newW > 0) r.w = newW * scalePx;
  if (!isNaN(newH) && newH > 0) r.h = newH * scalePx;
  updateRoomsList();
  drawAll();
  addBotMessage('×¢×•×“×›×Ÿ: ' + r.name + ' (' + (r.w/scalePx).toFixed(1) + 'Ã—' + (r.h/scalePx).toFixed(1) + ' ×\')');
});

document.getElementById('btn-delete-room').addEventListener('click', () => {
  if (selectedRoom === null) return;
  rooms.splice(selectedRoom, 1);
  selectedRoom = null;
  updatePropPanel();
  updateRoomsList();
  drawAll();
  addBotMessage('×”×—×“×¨ × ××—×§.');
});

// ===========================
// ROOMS LIST
// ===========================
function updateRoomsList() {
  const list = document.getElementById('rooms-list');
  if (rooms.length === 0) {
    list.innerHTML = '<div style="color:#aaa;font-size:0.85em;padding:8px;">×¢×“×™×™×Ÿ ×œ× ×¦×•×™×¨×• ×—×“×¨×™×.<br>×‘×—×¨ ×›×œ×™ "×”×•×¡×£ ×—×“×¨" ×•×¦×™×™×¨!</div>';
    return;
  }
  list.innerHTML = '';
  let totalArea = 0;
  rooms.forEach((room, i) => {
    const type = ROOM_TYPES[room.type] || ROOM_TYPES.room;
    const area = ((room.w / scalePx) * (room.h / scalePx)).toFixed(1);
    totalArea += parseFloat(area);
    const div = document.createElement('div');
    div.className = 'room-item' + (i === selectedRoom ? ' selected' : '');
    div.innerHTML = `<div class="room-color-dot" style="background:${type.color};border:1px solid #ccc;"></div>
      <span>${type.icon} ${room.name || type.label}</span>
      <span style="margin-right:auto;font-size:0.82em;color:#888;">${area} ×"×¨</span>`;
    div.addEventListener('click', () => {
      selectedRoom = i;
      setTool('select');
      updatePropPanel();
      updateRoomsList();
      drawAll();
    });
    list.appendChild(div);
  });
  const summary = document.createElement('div');
  summary.style.cssText = 'font-size:0.8em;color:#888;padding:6px 8px;border-top:1px solid #eee;margin-top:4px;';
  summary.textContent = `×¡×”"×›: ${rooms.length} ${rooms.length === 1 ? '×—×“×¨' : '×—×“×¨×™×'} | ${totalArea.toFixed(1)} ×"×¨`;
  list.appendChild(summary);
}

// ===========================
// BACKGROUND IMAGE
// ===========================
document.getElementById('upload-bg').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => { bgImage = img; drawAll(); addBotMessage('×©×¨×˜×•×˜ ×”×¨×§×¢ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×›×¢×ª ×ª×•×›×œ ×œ×¦×™×™×¨ ×—×“×¨×™× ××¢×œ×™×•.'); };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

document.getElementById('btn-clear-bg').addEventListener('click', () => {
  bgImage = null;
  drawAll();
  addBotMessage('×ª××•× ×ª ×”×¨×§×¢ ×”×•×¡×¨×”.');
});

// ===========================
// SCALE
// ===========================
document.getElementById('scale-px').addEventListener('change', e => {
  scalePx = parseInt(e.target.value) || 50;
  drawAll();
  setStatus('×¡×§××œ×” ×¢×•×“×›× ×”: ' + scalePx + ' ×¤×™×§×¡×œ = 1 ××˜×¨');
});

// ===========================
// SAVE / LOAD / CLEAR
// ===========================
document.getElementById('btn-save').addEventListener('click', () => {
  const data = JSON.stringify({ rooms, scalePx });
  fetch('/api/save-page', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ page: 'floor-plan', data })
  }).then(() => addBotMessage('×”×©×¨×˜×•×˜ × ×©××¨ ×‘×”×¦×œ×—×”! âœ…'))
    .catch(err => {
      console.error('Save failed, falling back to download:', err);
      // fallback: download
      const blob = new Blob([data], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'floor-plan.json';
      a.click();
      addBotMessage('×”×©×¨×˜×•×˜ ×”×•×¨×“ ×›×§×•×‘×¥. âœ…');
    });
});

document.getElementById('btn-load').addEventListener('click', () => {
  fetch('/api/page/floor-plan')
    .then(r => r.json())
    .then(data => {
      if (data && data.rooms) {
        rooms = data.rooms || [];
        scalePx = data.scalePx || 50;
        document.getElementById('scale-px').value = scalePx;
        selectedRoom = null;
        updatePropPanel();
        updateRoomsList();
        drawAll();
        addBotMessage('×”×©×¨×˜×•×˜ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ' + rooms.length + ' ×—×“×¨×™× × ××¦××•.');
      } else {
        addBotMessage('×œ× × ××¦× ×©×¨×˜×•×˜ ×©××•×¨. ×”×ª×—×œ ×œ×¦×™×™×¨!');
      }
    })
    .catch(err => { console.error('Load failed:', err); addBotMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×¨×˜×•×˜. ×•×“× ×©×”×©×¨×ª ×¤×•×¢×œ ×•× ×¡×” ×©× ×™×ª.'); });
});

document.getElementById('btn-clear-all').addEventListener('click', () => {
  if (rooms.length === 0 && !bgImage) return;
  if (!confirm('×”×× ×œ× ×§×•×ª ××ª ×›×œ ×”×©×¨×˜×•×˜?')) return;
  rooms = [];
  bgImage = null;
  selectedRoom = null;
  roomCounter = 1;
  updatePropPanel();
  updateRoomsList();
  drawAll();
  addBotMessage('×”×©×¨×˜×•×˜ × ×•×§×”. ××•×›×Ÿ ×œ×”×ª×—×™×œ ××—×“×©!');
});

// ===========================
// STATUS BAR
// ===========================
function setStatus(msg) {
  statusBar.textContent = msg;
}

// ===========================
// CHAT ASSISTANT
// ===========================
const BOT_RESPONSES = [
  {
    keys: ['×©×œ×•×','×”×™×™','×‘×•×§×¨','×¢×¨×‘','××” ×©×œ×•××š','××” × ×©××¢'],
    reply: '×©×œ×•×! ×× ×™ ×¡×•×›×Ÿ ×ª×›× ×•×Ÿ ×”×‘×™×ª ×©×œ ×.×© ××œ×•××™× ×™×•× ×—×•×¥. ×× ×™ ×›××Ÿ ×œ×¢×–×•×¨ ×œ×š ×œ×ª×›× ×Ÿ ××ª ×”×‘×™×ª ×©×œ×š, ×œ×”×•×¡×™×£ ×—×“×¨×™× ×•×œ×ª×›× ×Ÿ ×”×ª×§× ×ª ×¤×¨×’×•×œ×•×ª, ×©×¢×¨×™× ×•×’×“×¨×•×ª. ğŸ˜Š'
  },
  {
    keys: ['×’×“×œ','×”×’×“×œ','××’×“×™×œ','×’×“×œ×™×','×©×˜×—','×"×¨','××˜×¨','×”×’×“×œ','×œ×’×“×œ'],
    reply: '×œ×”×’×“×œ×ª ×—×“×¨:\n1. ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "ğŸ–±ï¸ ×‘×—×¨" ×•×‘×—×¨ ××ª ×”×—×“×¨\n2. ×’×¨×•×¨ ××ª ×”×™×“×™×•×ª ×”×¦×”×•×‘×•×ª ×‘×¤×™× ×•×ª/×¦×“×“×™× ×œ×©×™× ×•×™ ×’×•×“×œ\n\n××• ×œ×—×¥ ×¢×œ "â†” ×’×“×œ" ×•×‘×—×¨ ××ª ×”×—×“×¨, ×•××– ×©× ×” ××ª ×”××™×“×•×ª ×‘×¤×× ×œ ×”×™×× ×™.'
  },
  {
    keys: ['×—×“×¨','×”×•×¡×£ ×—×“×¨','×—×“×¨×™×','×¦×™×™×¨','×©×¨×˜×•×˜'],
    reply: '×›×“×™ ×œ×”×•×¡×™×£ ×—×“×¨:\n1. ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "â• ×—×“×¨" ×‘×¡×¨×’×œ ×”×›×œ×™×\n2. ×’×¨×•×¨ ×¢×œ ×”×œ×•×— ×›×“×™ ×œ×¦×™×™×¨ ××ª ×”×—×“×¨\n3. ×‘×—×¨ ××ª ×”×—×“×¨ ×•×¢×“×›×Ÿ ××ª ×©××• ×•××™×“×•×ª×™×• ×‘×¤×× ×œ ×”×™×× ×™'
  },
  {
    keys: ['××—×§','×”×¡×¨','×‘×™×˜×•×œ'],
    reply: '×œ××—×™×§×ª ×—×“×¨:\n1. ×œ×—×¥ ×¢×œ "ğŸ—‘ ××—×§" ×‘×¡×¨×’×œ ×”×›×œ×™×\n2. ×œ×—×¥ ×¢×œ ×”×—×“×¨ ×©×‘×¨×¦×•× ×š ×œ××—×•×§\n\n××• ×‘×—×¨ ×—×“×¨ ×•×œ×—×¥ "ğŸ—‘ ××—×§ ×—×“×¨" ×‘×¤×× ×œ ×”×™××™×Ÿ.'
  },
  {
    keys: ['×©××•×¨','×©××™×¨×”','save'],
    reply: '×œ×©××™×¨×ª ×”×©×¨×˜×•×˜ ×œ×—×¥ ×¢×œ "ğŸ’¾ ×©××•×¨". ×”×©×¨×˜×•×˜ ×™×™×©××¨ ×‘×©×¨×ª. ×‘×¤×¢× ×”×‘××” ×œ×—×¥ "ğŸ“¥ ×˜×¢×Ÿ" ×›×“×™ ×œ×˜×¢×•×Ÿ ××•×ª×•.'
  },
  {
    keys: ['×¨×§×¢','×©×¨×˜×•×˜','×ª××•× ×”','×ª×•×›× ×™×ª','×§×•×‘×¥'],
    reply: '×œ×”×¢×œ××ª ×ª×•×›× ×™×ª ×”×‘×™×ª:\n1. ×œ×—×¥ ×¢×œ "ğŸ“‚ ×˜×¢×Ÿ ×©×¨×˜×•×˜"\n2. ×‘×—×¨ ×ª××•× ×” ×©×œ ×ª×•×›× ×™×ª ×”×‘×™×ª ×©×œ×š\n×”×ª××•× ×” ×ª×•×¦×’ ×›×¨×§×¢ ×©×§×•×£ ×•×ª×•×›×œ ×œ×¦×™×™×¨ ××¢×œ×™×”.'
  },
  {
    keys: ['×¤×¨×’×•×œ×”','×¤×¨×’×•×œ×•×ª'],
    reply: '×¤×¨×’×•×œ×” ×”×™× ×ª×•×¡×¤×ª × ×¤×œ××” ×œ×‘×™×ª! ×›×“×™ ×œ×¡××Ÿ ××§×•× ×œ×¤×¨×’×•×œ×”:\n1. ×”×•×¡×£ ×—×“×¨ ×—×“×©\n2. ×‘×—×¨ ××•×ª×•\n3. ×©× ×” ××ª ×”×¡×•×’ ×œ"×¤×¨×’×•×œ×”" ×‘×¤×× ×œ ×”×™×× ×™\n\n×¨×•×¦×” ×œ×§×‘×œ ×”×¦×¢×ª ××—×™×¨ ×œ×¤×¨×’×•×œ×”? ×¦×•×¨ ×§×©×¨ ×“×¨×š ×”×“×£ ×”×¨××©×™! ğŸ '
  },
  {
    keys: ['×©×¢×¨','×©×¢×¨×™×'],
    reply: '×©×¢×¨ ×”×•× ×›×¨×˜×™×¡ ×”×‘×™×§×•×¨ ×©×œ ×”×‘×™×ª! ×œ×¡×™××•×Ÿ ××™×§×•× ×”×©×¢×¨ ×‘×©×¨×˜×•×˜, ×”×•×¡×£ ×—×“×¨ ×¦×¨ ×‘×›× ×™×¡×”. ×œ×§×‘×œ×ª ×”×¦×¢×ª ××—×™×¨ ×œ×©×¢×¨, ×¦×•×¨ ×§×©×¨ ×“×¨×š ×”×“×£ ×”×¨××©×™.'
  },
  {
    keys: ['×’×“×¨','×’×“×¨×•×ª'],
    reply: '×œ×¡×™××•×Ÿ ×’×“×¨ ×‘×©×¨×˜×•×˜, × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×—×“×¨ ×“×§ ×œ××•×¨×š ×’×‘×•×œ×•×ª ×”× ×›×¡. ×œ×§×‘×œ×ª ×”×¦×¢×ª ××—×™×¨ ×œ×’×“×¨ ××œ×•××™× ×™×•×, ×¦×•×¨ ×§×©×¨ ×“×¨×š ×”×“×£ ×”×¨××©×™.'
  },
  {
    keys: ['××˜×‘×—','×¡×œ×•×Ÿ','×©×™× ×”','×××‘×˜×™×”','×©×™×¨×•×ª×™×'],
    reply: '××¤×©×¨ ×œ×¡××Ÿ ×—×“×¨×™× ×œ×¤×™ ×¡×•×’! ×œ××—×¨ ×¦×™×•×¨ ×”×—×“×¨, ×‘×—×¨ ××•×ª×• ×•×‘×¤×× ×œ ×”×™×× ×™ ×©× ×” ××ª "×¡×•×’" ×œ×¡×œ×•×Ÿ/××˜×‘×—/×—×“×¨ ×©×™× ×” ×•×›×•\'.'
  },
  {
    keys: ['×’×•×“×œ','×›××” ××˜×¨','×©×˜×— ×”×‘×™×ª','×—×©×‘'],
    reply: '×œ×—×™×©×•×‘ ×”×©×˜×— ×”×›×•×œ×œ, ×¨××” ××ª ×”×¡×™×›×•× ×‘×ª×—×ª×™×ª ×¨×©×™××ª ×”×—×“×¨×™× ×‘×¤×× ×œ ×”×™×× ×™. ×œ×©×™× ×•×™ ××™×“×•×ª ××“×•×™×§×•×ª, ×‘×—×¨ ×—×“×¨ ×•×¢×“×›×Ÿ ××ª ×”×¨×•×—×‘ ×•×”×¢×•××§ ×‘×¤×× ×œ.'
  },
  {
    keys: ['×¢×–×¨×”','help','××™×š','××” ×œ×¢×©×•×ª'],
    reply: '×”× ×” ××“×¨×™×š ××”×™×¨:\nâ€¢ "â• ×—×“×¨" â€“ ×¦×™×•×¨ ×—×“×¨ ×—×“×© (×œ×—×¥ ×•×’×¨×•×¨)\nâ€¢ "ğŸ–±ï¸ ×‘×—×¨" â€“ ×‘×—×¨/×”×–×– ×—×“×¨\nâ€¢ "â†” ×’×“×œ" â€“ ×©×™× ×•×™ ×’×•×“×œ (×™×“×™×•×ª ×¦×”×•×‘×•×ª)\nâ€¢ "ğŸ—‘ ××—×§" â€“ ××—×™×§×ª ×—×“×¨\nâ€¢ "ğŸ“‚ ×˜×¢×Ÿ ×©×¨×˜×•×˜" â€“ ×¨×§×¢ ×ª××•× ×”\nâ€¢ ×¤×× ×œ ×™××™×Ÿ â€“ ×¢×¨×™×›×ª ×¤×¨×˜×™ ×—×“×¨'
  }
];

function getBotResponse(msg) {
  const lower = msg.toLowerCase();
  for (const r of BOT_RESPONSES) {
    if (r.keys.some(k => lower.includes(k))) {
      return r.reply;
    }
  }
  // Default response with room summary
  if (rooms.length > 0) {
    const total = rooms.reduce((s, r) => s + (r.w / scalePx) * (r.h / scalePx), 0);
    return `×™×© ×œ×š ×›×¨×’×¢ ${rooms.length} ×—×“×¨×™× ×¢× ×©×˜×— ×›×•×œ×œ ×©×œ ${total.toFixed(1)} ×"×¨. ×©××œ ××•×ª×™ ×¢×œ: ×”×•×¡×¤×ª ×—×“×¨×™×, ×©×™× ×•×™ ×’×“×œ×™×, ×”×¢×œ××ª ×©×¨×˜×•×˜, ×¤×¨×’×•×œ×•×ª, ×©×¢×¨×™× ×•×’×“×¨×•×ª.`;
  }
  return '×©××œ ××•×ª×™ ×¢×œ: ×”×•×¡×¤×ª ×—×“×¨×™×, ×©×™× ×•×™ ×’×“×œ×™×, ×”×¢×œ××ª ×©×¨×˜×•×˜, ×¤×¨×’×•×œ×•×ª, ×©×¢×¨×™× ×•×’×“×¨×•×ª. ×× ×™ ×›××Ÿ ×œ×¢×–×•×¨! ğŸ˜Š';
}

function addMessage(text, who) {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + who;
  div.style.whiteSpace = 'pre-wrap';
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addBotMessage(text) { addMessage(text, 'bot'); }
function addUserMessage(text) { addMessage(text, 'user'); }

function sendChat() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  addUserMessage(msg);
  input.value = '';
  setTimeout(() => addBotMessage(getBotResponse(msg)), 400);
}

document.getElementById('chat-send').addEventListener('click', sendChat);
document.getElementById('chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendChat();
});

// ===========================
// INIT
// ===========================
setTool('room');
drawAll();
updateRoomsList();
addBotMessage('×©×œ×•×! ×× ×™ ×¡×•×›×Ÿ ×ª×›× ×•×Ÿ ×”×‘×™×ª ×©×œ×š. ğŸ \n\n×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š:\nâ€¢ ×œ×¦×™×™×¨ ×•×œ×¨××•×ª ×©×¨×˜×•×˜×™ ×”×‘×™×ª\nâ€¢ ×œ×”×•×¡×™×£ ×•×œ× ×”×œ ×—×“×¨×™×\nâ€¢ ×œ×ª×›× ×Ÿ ××™×§×•× ×¤×¨×’×•×œ×•×ª, ×©×¢×¨×™× ×•×’×“×¨×•×ª\n\n×”×ª×—×œ ×‘×¦×™×•×¨ ×—×“×¨ â€“ ×œ×—×¥ "â• ×—×“×¨" ×•×œ×—×¥-×•×’×¨×•×¨ ×¢×œ ×”×œ×•×—!');
</script>
</body>
</html>
